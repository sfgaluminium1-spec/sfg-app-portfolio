"use strict";exports.id=49,exports.ids=[49],exports.modules={60049:(e,t,i)=>{i.d(t,{e:()=>A});var n=i(83178),a=i(53524),s=i(12354);let o={INVOICE:{patterns:{fileName:[/invoice/i,/inv[-_]?\d+/i,/bill/i],content:["INVOICE","PAYMENT DUE","TOTAL AMOUNT","VAT","TAX INVOICE"],extensions:[".pdf",".doc",".docx",".xls",".xlsx"]},retentionYears:7,versioned:!1,confidence:{fileName:30,content:70,combined:85}},PURCHASE_ORDER:{patterns:{fileName:[/purchase.?order/i,/po[-_]?\d+/i,/p\.?o\./i],content:["PURCHASE ORDER","PO NUMBER","ORDER DATE","DELIVERY DATE"],extensions:[".pdf",".doc",".docx"]},retentionYears:7,versioned:!1,confidence:{fileName:30,content:70,combined:85}},DELIVERY_NOTE:{patterns:{fileName:[/delivery.?note/i,/dn[-_]?\d+/i,/dispatch/i],content:["DELIVERY NOTE","DELIVERY DATE","DELIVERED BY","SIGNATURE"],extensions:[".pdf",".doc",".docx"]},retentionYears:7,versioned:!1,confidence:{fileName:30,content:70,combined:85}},QUOTE:{patterns:{fileName:[/quote/i,/quotation/i,/q[-_]?\d+/i,/estimate/i],content:["QUOTATION","QUOTE","ESTIMATE","VALID UNTIL","PRICES"],extensions:[".pdf",".doc",".docx",".xls",".xlsx"]},retentionYears:7,versioned:!0,confidence:{fileName:30,content:70,combined:85}},DYNAMIC_PRICING:{patterns:{fileName:[/pricing/i,/price.?list/i,/rates/i],content:["PRICING","RATE CARD","PRICE LIST","TARIFF"],extensions:[".xls",".xlsx",".pdf"]},retentionYears:7,versioned:!0,confidence:{fileName:30,content:70,combined:85}},DRAWING:{patterns:{fileName:[/drawing/i,/dwg/i,/plan/i,/diagram/i,/\.dwg$/i],content:["DRAWING","SCALE","REV","REVISION","DRAWING NO"],extensions:[".dwg",".pdf",".dxf",".png",".jpg"]},retentionYears:999,versioned:!0,confidence:{fileName:40,content:60,combined:85}},TECHNICAL_SPEC:{patterns:{fileName:[/spec(?:ification)?/i,/technical/i,/datasheet/i],content:["SPECIFICATION","TECHNICAL","DATASHEET","DIMENSIONS"],extensions:[".pdf",".doc",".docx"]},retentionYears:999,versioned:!0,confidence:{fileName:30,content:70,combined:85}},WARRANTY:{patterns:{fileName:[/warranty/i,/guarantee/i],content:["WARRANTY","GUARANTEE","WARRANTEE","COVERAGE"],extensions:[".pdf",".doc",".docx"]},retentionYears:999,versioned:!1,confidence:{fileName:40,content:60,combined:85}},WARRANTY_RECALL:{patterns:{fileName:[/warranty.?recall/i,/product.?recall/i,/safety.?notice/i],content:["RECALL","SAFETY NOTICE","PRODUCT RECALL","WARRANTY RECALL"],extensions:[".pdf",".doc",".docx"]},retentionYears:999,versioned:!1,confidence:{fileName:50,content:50,combined:85}},CONTRACT:{patterns:{fileName:[/contract/i,/agreement/i,/terms/i],content:["CONTRACT","AGREEMENT","TERMS AND CONDITIONS","PARTIES AGREE"],extensions:[".pdf",".doc",".docx"]},retentionYears:999,versioned:!1,confidence:{fileName:30,content:70,combined:85}},CORRESPONDENCE:{patterns:{fileName:[/letter/i,/correspondence/i,/email/i],content:["DEAR","SINCERELY","REGARDS","FROM:","TO:","SUBJECT:"],extensions:[".pdf",".doc",".docx",".msg",".eml"]},retentionYears:7,versioned:!1,confidence:{fileName:20,content:80,combined:85}},EMAIL:{patterns:{fileName:[/\.msg$/i,/\.eml$/i],content:["FROM:","TO:","SUBJECT:","DATE:","SENT:"],extensions:[".msg",".eml",".mbox"]},retentionYears:7,versioned:!1,confidence:{fileName:60,content:40,combined:85}},PRODUCT_SPEC:{patterns:{fileName:[/product/i,/catalog/i,/brochure/i],content:["PRODUCT","SPECIFICATIONS","FEATURES","MODEL"],extensions:[".pdf",".doc",".docx"]},retentionYears:999,versioned:!1,confidence:{fileName:30,content:70,combined:85}},PHOTO:{patterns:{fileName:[/photo/i,/img/i,/image/i,/pic/i],content:[],extensions:[".jpg",".jpeg",".png",".gif",".bmp",".tiff",".heic"]},retentionYears:7,versioned:!1,confidence:{fileName:20,content:0,combined:70}},SPREADSHEET:{patterns:{fileName:[],content:[],extensions:[".xls",".xlsx",".csv",".ods"]},retentionYears:7,versioned:!1,confidence:{fileName:0,content:0,combined:60}},PRESENTATION:{patterns:{fileName:[/presentation/i,/slides/i],content:[],extensions:[".ppt",".pptx",".odp"]},retentionYears:7,versioned:!1,confidence:{fileName:20,content:0,combined:70}}};function r(e){let t;let i=e.fileName.toLowerCase(),n=i.substring(i.lastIndexOf(".")),a=(e.textContent||"").toUpperCase(),s=(e.metadata?.folderPath||"").toLowerCase(),r=null;for(let[e,t]of Object.entries(o)){let o=[],c=0,d=0;if(t.patterns.fileName.length>0){for(let n of(d+=t.confidence.fileName,t.patterns.fileName))if(n.test(i)||n.test(s)){c+=t.confidence.fileName,o.push(`Filename matches ${e} pattern`);break}}if(t.patterns.extensions.length>0&&t.patterns.extensions.includes(n)&&(c+=10,d+=10,o.push(`Extension ${n} matches ${e}`)),t.patterns.content.length>0&&a){d+=t.confidence.content;let i=0;for(let e of t.patterns.content)a.includes(e)&&i++;i>0&&(c+=i/t.patterns.content.length*t.confidence.content,o.push(`Content matches ${i}/${t.patterns.content.length} ${e} keywords`))}let l=d>0?c/d*100:0;l>(r?.confidence||0)&&(r={fileType:e,confidence:l,retentionYears:t.retentionYears,versioned:t.versioned,reasons:o})}return!r||r.confidence<40?{fileType:"UNCLASSIFIED",confidence:r?.confidence||0,confidenceLevel:"LOW",method:"RULE_BASED",retentionYears:7,isVersioned:!1,suggestedTags:d(e),reasoning:r?.reasons||["No matching patterns found"]}:(t=r.confidence>=85?"HIGH":r.confidence>=50?"MEDIUM":"LOW",{fileType:r.fileType,confidence:r.confidence,confidenceLevel:t,method:"RULE_BASED",retentionYears:r.retentionYears,isVersioned:r.versioned,suggestedTags:d(e),reasoning:r.reasons})}async function c(e){try{let t=r(e);if(t.confidence>=85||!e.textContent)return t;let i=`Analyze this document and classify it into ONE of these types:
INVOICE, PURCHASE_ORDER, DELIVERY_NOTE, QUOTE, DYNAMIC_PRICING, DRAWING, TECHNICAL_SPEC, 
WARRANTY, WARRANTY_RECALL, CONTRACT, CORRESPONDENCE, EMAIL, PRODUCT_SPEC, PRODUCT_CATALOG,
PHOTO, REPORT, SPREADSHEET, PRESENTATION, OTHER, UNCLASSIFIED

File name: ${e.fileName}
File size: ${e.fileSize} bytes
Folder path: ${e.metadata?.folderPath||"unknown"}

Content preview (first 500 chars):
${e.textContent.substring(0,500)}

Respond with ONLY the classification type (e.g., "INVOICE") and confidence (0-100) in this format:
TYPE: [classification]
CONFIDENCE: [0-100]
REASONING: [brief explanation]`,n=await s.K.ragQuery(i,"You are a document classification expert."),a=n.match(/TYPE:\s*(\w+)/i),c=n.match(/CONFIDENCE:\s*(\d+)/i),l=n.match(/REASONING:\s*(.+)/i);if(a&&c){let t=a[1].toUpperCase(),i=parseInt(c[1]),n=l?[l[1].trim()]:["AI classification"],s=o[t];return{fileType:t,confidence:i,confidenceLevel:i>=85?"HIGH":i>=50?"MEDIUM":"LOW",method:"AI_ASSISTED",retentionYears:s?.retentionYears||7,isVersioned:s?.versioned||!1,suggestedTags:d(e),reasoning:n}}return{...t,method:"AI_ASSISTED",reasoning:[...t.reasoning,"AI classification failed, using rules"]}}catch(i){console.error("AI classification error:",i);let t=r(e);return{...t,reasoning:[...t.reasoning,"AI error, using rule-based classification"]}}}function d(e){let t=[],i=e.fileName.match(/20\d{2}/);for(let n of(i?t.push({key:"year",value:i[0],confidence:80}):e.metadata?.dateCreated&&t.push({key:"year",value:e.metadata.dateCreated.getFullYear().toString(),confidence:90}),[/\b\d{5}\b/,/ENQ[-_]?\d{4}[-_]?\d{4}/i,/\d{4}[-_]ENQ/i])){let i=e.fileName.match(n);if(i){t.push({key:"job",value:i[0],confidence:70});break}}let n=e.fileName.substring(e.fileName.lastIndexOf("."));return n&&t.push({key:"extension",value:n,confidence:100}),t}async function l(e,t){let i={fileName:e,textContent:t,fileSize:0},n=r(i);if(n.confidence>=85)return n;try{let e=await c(i);if(e.confidence>n.confidence)return e}catch(e){console.error("AI classification failed:",e)}return n}var f=i(72960),p=i(36396),h=i(24041),u=i(49192),E=i(21841);let m=new E.S3Client({}),{bucketName:N,folderPrefix:g}={bucketName:process.env.AWS_BUCKET_NAME,folderPrefix:process.env.AWS_FOLDER_PREFIX||""};async function I(e,t){let i=`${g}uploads/${Date.now()}-${t}`,n=new E.PutObjectCommand({Bucket:N,Key:i,Body:e});return await m.send(n),i}class R{async createBatch(e){return n._.processingBatch.create({data:{batchName:e.batchName,description:`Processing files from ${e.sourceLocation}`,sourceLocation:e.sourceLocation,totalSizeGB:0,estimatedFiles:e.maxFiles,status:a.BatchStatus.PENDING}})}async startBatch(e){if(this.activeProcesses.has(e))throw Error("Batch is already processing");this.activeProcesses.set(e,!0);try{await n._.processingBatch.update({where:{id:e},data:{status:a.BatchStatus.PROCESSING,startedAt:new Date}}),await this.processBatch(e),await n._.processingBatch.update({where:{id:e},data:{status:a.BatchStatus.COMPLETED,completedAt:new Date}})}catch(t){console.error("Batch processing error:",t),await n._.processingBatch.update({where:{id:e},data:{status:a.BatchStatus.FAILED}})}finally{this.activeProcesses.delete(e)}}async processBatch(e){let t=await n._.archivedFile.findMany({where:{batchId:e,processingStatus:a.ProcessingStatus.PENDING}});if(!await n._.processingBatch.findUnique({where:{id:e}}))throw Error("Batch not found");await n._.processingBatch.update({where:{id:e},data:{filesQueued:t.length}});let i=0,s=0,o=0;for(let a of t){try{await this.processFile(a.id),s++}catch(t){console.error(`Error processing file ${a.id}:`,t),o++,await this.logError(e,a.id,a.fileName,t)}let r=++i/t.length*100;await n._.processingBatch.update({where:{id:e},data:{filesProcessed:i,filesSucceeded:s,filesFailed:o,progress:r}})}}async processFile(e){let t=Date.now();await n._.archivedFile.update({where:{id:e},data:{processingStatus:a.ProcessingStatus.ANALYZING,processingAttempts:{increment:1},lastProcessedAt:new Date}});let i=await n._.archivedFile.findUnique({where:{id:e}});if(!i)throw Error("File not found");try{let s=await this.downloadFile(i),o=await this.uploadToCloud(i.fileName,s),r=await f.c.extractContent(s,i.mimeType||"application/octet-stream",i.fileName),c=await l(i.fileName,r.text),d=await p.t.generateTags(e,i.fileName,r.text,r.entities);await n._.archivedFile.update({where:{id:e},data:{cloudStoragePath:o,fileType:c.fileType,confidence:c.confidence,classificationMethod:c.method,textContent:r.text,jobNumber:d.jobNumber,customerName:d.customerName,productType:d.productType,retentionYears:c.retentionYears,processingStatus:c.confidence>=50?a.ProcessingStatus.CLASSIFIED:a.ProcessingStatus.NEEDS_REVIEW}}),await p.t.applyTags(e,d.tags);let u=await h.n.discoverRelationships(e);await h.n.createRelationships(u),await n._.archivedFile.update({where:{id:e},data:{processingStatus:a.ProcessingStatus.COMPLETED}});let E=Date.now()-t;await this.logProcessing(i.batchId||"",e,i.fileName,E)}catch(t){throw await n._.archivedFile.update({where:{id:e},data:{processingStatus:a.ProcessingStatus.FAILED,processingError:t.message}}),t}}async downloadFile(e){if(!e.sharePointDriveId||!e.sharePointItemId)throw Error("SharePoint information missing");let t=await u.q.getFileContent("root",e.sharePointDriveId,e.sharePointItemId),i=[],n=t.getReader();for(;;){let{done:e,value:t}=await n.read();if(e)break;i.push(t)}return Buffer.concat(i)}async uploadToCloud(e,t){let i=Date.now(),n=e.replace(/[^a-zA-Z0-9.-]/g,"_"),a=`archived/${i}-${n}`;return await I(t,a),a}async logProcessing(e,t,i,s){await n._.processingLog.create({data:{level:a.LogLevel.INFO,category:"processing",message:`Successfully processed file: ${i}`,fileId:t,fileName:i,batchId:e,duration:s}})}async logError(e,t,i,s){await n._.processingLog.create({data:{level:a.LogLevel.ERROR,category:"error",message:`Failed to process file: ${i}`,fileId:t,fileName:i,batchId:e,errorCode:s.code,errorStack:s.stack}})}async getBatchProgress(e){let t;let i=await n._.processingBatch.findUnique({where:{id:e}});if(!i)throw Error("Batch not found");return i.startedAt&&i.filesProcessed>0&&(t=Math.round((Date.now()-i.startedAt.getTime())/i.filesProcessed*(i.filesQueued-i.filesProcessed)/1e3/60)),{batchId:e,progress:i.progress,filesProcessed:i.filesProcessed,filesSucceeded:i.filesSucceeded,filesFailed:i.filesFailed,estimatedTimeRemaining:t}}async pauseBatch(e){this.activeProcesses.delete(e),await n._.processingBatch.update({where:{id:e},data:{status:a.BatchStatus.PAUSED}})}async getAllBatches(){return n._.processingBatch.findMany({orderBy:{createdAt:"desc"}})}constructor(){this.activeProcesses=new Map}}let A=new R},24041:(e,t,i)=>{i.d(t,{n:()=>o});var n=i(83178),a=i(53524);class s{async discoverRelationships(e){let t=await n._.archivedFile.findUnique({where:{id:e},include:{tags:!0}});if(!t)return[];let i=[];return t.jobNumber&&i.push(...await this.findJobRelationships(e,t.jobNumber)),i.push(...await this.findVersionRelationships(e,t.fileName)),t.customerName&&i.push(...await this.findCustomerRelationships(e,t.customerName)),i}async findJobRelationships(e,t){return(await n._.archivedFile.findMany({where:{jobNumber:t,id:{not:e}},take:50})).map(i=>({sourceFileId:e,targetFileId:i.id,type:a.RelationshipType.RELATED_TO_JOB,strength:8,reason:`Both files belong to job ${t}`}))}async findVersionRelationships(e,t){let i=[],s=t.match(/(.*?)[-_]?v?(\d+)(\.[^.]+)?$/i);if(!s)return[];let o=s[1],r=parseInt(s[2]);for(let t of(await n._.archivedFile.findMany({where:{fileName:{contains:o,mode:"insensitive"},id:{not:e}}}))){let n=t.fileName.match(/(.*?)[-_]?v?(\d+)(\.[^.]+)?$/i);if(n){let s=parseInt(n[2]);s<r?i.push({sourceFileId:e,targetFileId:t.id,type:a.RelationshipType.VERSION_OF,strength:9,reason:`Version ${r} supersedes version ${s}`}):s>r&&i.push({sourceFileId:t.id,targetFileId:e,type:a.RelationshipType.VERSION_OF,strength:9,reason:`Version ${s} supersedes version ${r}`})}}return i}async findCustomerRelationships(e,t){return(await n._.archivedFile.findMany({where:{customerName:{contains:t,mode:"insensitive"},id:{not:e}},take:20})).map(i=>({sourceFileId:e,targetFileId:i.id,type:a.RelationshipType.RELATED_TO_JOB,strength:6,reason:`Both files related to customer ${t}`}))}async createRelationships(e){let t=0;for(let i of e)try{await n._.fileRelationship.create({data:{sourceFileId:i.sourceFileId,targetFileId:i.targetFileId,relationshipType:i.type,strength:i.strength,description:i.reason}}),t++}catch(e){continue}return t}async getFileRelationships(e){let[t,i]=await Promise.all([n._.fileRelationship.findMany({where:{sourceFileId:e},include:{targetFile:!0}}),n._.fileRelationship.findMany({where:{targetFileId:e},include:{sourceFile:!0}})]);return{outgoing:t,incoming:i}}async reconstructJobFolder(e){let t=await n._.archivedFile.findMany({where:{jobNumber:e},include:{tags:!0,relationships:{include:{targetFile:!0}}},orderBy:{createdAt:"asc"}});return{jobNumber:e,fileCount:t.length,files:t,totalSize:t.reduce((e,t)=>e+Number(t.fileSize),0)}}}let o=new s}};