"use strict";exports.id=1965,exports.ids=[1965],exports.modules={19356:(e,t,r)=>{r.d(t,{d:()=>h});var s=r(64617),a=r(66291),n=r(80207),o=r(3390),i=r.n(o),c=r(83178),l=r(29061),u=r(52075);let d=process.env.AZURE_KEY_VAULT_URL||"",m="true"===process.env.USE_AZURE_KEY_VAULT,p=null;async function y(e,t){let r=function(){if(!m||!d)return null;if(!p)try{let e;process.env.AZURE_CLIENT_ID&&process.env.AZURE_CLIENT_SECRET&&process.env.AZURE_TENANT_ID?e=new u.Rp(process.env.AZURE_TENANT_ID,process.env.AZURE_CLIENT_ID,process.env.AZURE_CLIENT_SECRET):e=new u.y0,p=new l.rx(d,e)}catch(e){return console.error("Failed to initialize Key Vault client:",e),null}return p}();if(!r){if(t){let e=process.env[t];return void 0!==e?e:null}return null}try{return(await r.getSecret(e)).value||null}catch(r){if(console.error(`Failed to get secret '${e}' from Key Vault:`,r),t){let e=process.env[t];return void 0!==e?e:null}return null}}async function h(){let e=[(0,a.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let t=await c._.user.findUnique({where:{email:e.email}});return t&&t.password&&await i().compare(e.password,t.password)?{id:t.id,email:t.email,name:t.firstName?`${t.firstName} ${t.lastName||""}`.trim():t.email,role:t.role}:null}})],t=await y("sfg-wiki-entra-client-id","AZURE_AD_CLIENT_ID"),r=await y("sfg-wiki-entra-client-secret","AZURE_AD_CLIENT_SECRET"),o=await y("sfg-wiki-entra-tenant-id","AZURE_AD_TENANT_ID");return t&&r&&o&&e.push((0,n.Z)({clientId:t,clientSecret:r,tenantId:o,authorization:{params:{scope:"openid profile email User.Read"}}})),{adapter:(0,s.N)(c._),providers:e,session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{async signIn({user:e,account:t,profile:r}){if(t?.provider==="azure-ad")try{await c._.user.findUnique({where:{email:e.email}})||await c._.user.create({data:{email:e.email,firstName:r?.given_name||e.name?.split(" ")[0]||"",lastName:r?.family_name||e.name?.split(" ").slice(1).join(" ")||"",role:"USER",password:null}})}catch(e){return console.error("Error during Azure AD sign-in:",e),!1}return!0},jwt:async({token:e,user:t,account:r,profile:s})=>(t&&(e.role=t.role),r?.provider==="azure-ad"&&s&&(e.groups=s.groups||[],s.roles&&(s.roles.includes("SFG-Wiki-Admin")?e.role="ADMIN":s.roles.includes("SFG-Wiki-Approver")?e.role="APPROVER":s.roles.includes("SFG-Wiki-Editor")?e.role="EDITOR":s.roles.includes("SFG-Wiki-Viewer")&&(e.role="USER"))),e),session:async({session:e,token:t})=>(t&&(e.user.id=t.sub,e.user.role=t.role,e.user.groups=t.groups||[]),e)}}}},36396:(e,t,r)=>{r.d(t,{t:()=>o});var s=r(83178),a=r(72960);class n{async generateTags(e,t,r,s){let n=[],o=a.c.extractJobNumber(r,t);if(o&&n.push({key:"job_number",value:o,source:"Extracted",confidence:90}),s.customerNames?.length>0)for(let e of s.customerNames)n.push({key:"customer",value:e,source:"AI",confidence:80});if(s.productTypes?.length>0)for(let e of s.productTypes)n.push({key:"product_type",value:e,source:"AI",confidence:85});else{let e=a.c.extractProductType(r);e&&n.push({key:"product_type",value:e,source:"Extracted",confidence:70})}if(s.dates?.length>0)for(let e of s.dates)n.push({key:"document_date",value:e,source:"AI",confidence:75});let i=t.match(/20\d{2}/)||r.match(/20\d{2}/);i&&n.push({key:"year",value:i[0],source:"Extracted",confidence:95});let c=t.split(".").pop()?.toLowerCase();return c&&n.push({key:"file_extension",value:c,source:"Metadata",confidence:100}),{tags:n,jobNumber:o||void 0,customerName:s.customerNames?.[0],productType:s.productTypes?.[0]||a.c.extractProductType(r)||void 0}}async applyTags(e,t){for(let r of t)await s._.fileTag.create({data:{fileId:e,key:r.key,value:r.value,source:r.source,confidence:r.confidence}})}async getFileTags(e){return s._.fileTag.findMany({where:{fileId:e},orderBy:[{key:"asc"},{confidence:"desc"}]})}async searchByTag(e,t){return s._.fileTag.findMany({where:{key:e,value:{contains:t,mode:"insensitive"}},include:{file:!0}})}async getTagStats(){let e=await s._.fileTag.findMany({select:{key:!0,value:!0}}),t=e.reduce((e,t)=>(e[t.key]=(e[t.key]||0)+1,e),{}),r=e.reduce((e,t)=>(e[t.key]||(e[t.key]=new Set),e[t.key].add(t.value),e),{});return{totalTags:e.length,tagCounts:t,uniqueValues:Object.entries(r).reduce((e,[t,r])=>(e[t]=r.size,e),{})}}}let o=new n},72960:(e,t,r)=>{r.d(t,{c:()=>n});var s=r(12354);class a{async extractContent(e,t,r){let s="";try{t.includes("text")?s=e.toString("utf-8"):t.includes("pdf")?s=await this.extractFromPDF(e):t.includes("word")||t.includes("document")?s=await this.extractFromWord(e):(t.includes("spreadsheet")||t.includes("excel"))&&(s=await this.extractFromExcel(e));let r=await this.extractEntities(s);return{text:s.slice(0,5e4),metadata:{},entities:r}}catch(e){return console.error("Content extraction error:",e),{text:"",metadata:{},entities:{jobNumbers:[],customerNames:[],productTypes:[],dates:[],amounts:[]}}}}async extractFromPDF(e){if(e.length<1048576)try{let t=e.toString("base64");return(await s.K.chatCompletion({messages:[{role:"system",content:"Extract all text content from this document. Return only the text, no formatting."},{role:"user",content:`PDF file (base64): ${t.slice(0,1e3)}...`}],temperature:0})).choices[0].message.content}catch{}return""}async extractFromWord(e){return""}async extractFromExcel(e){return""}async extractEntities(e){if(!e||e.length<10)return{jobNumbers:[],customerNames:[],productTypes:[],dates:[],amounts:[]};try{let t=`{
        "jobNumbers": ["array of job numbers found - patterns like 19450, ENQ-2023-0156, 0234-ENQ"],
        "customerNames": ["array of customer/company names"],
        "productTypes": ["array of product types - roller shutter, door, window, glazing"],
        "dates": ["array of dates in ISO format"],
        "amounts": [{"value": number, "currency": "GBP/USD/EUR"}]
      }`,r=await s.K.extractData(e.slice(0,5e3),t);return{jobNumbers:r.jobNumbers||[],customerNames:r.customerNames||[],productTypes:r.productTypes||[],dates:r.dates||[],amounts:r.amounts||[]}}catch(e){return console.error("Entity extraction error:",e),{jobNumbers:[],customerNames:[],productTypes:[],dates:[],amounts:[]}}}extractJobNumber(e,t){let r=[/\b\d{5}\b/,/ENQ[-_]\d{4}[-_]\d{4}/i,/\d{4}[-_]ENQ/i,/JOB[-_]?\d+/i,/PROJECT[-_]?\d+/i];for(let e of r){let r=t.match(e);if(r)return r[0]}for(let t of r){let r=e.match(t);if(r)return r[0]}return null}async extractCustomerName(e){try{let t=(await s.K.chatCompletion({messages:[{role:"system",content:'Extract the customer/company name from this document. Return ONLY the company name, nothing else. If no customer is found, return "null".'},{role:"user",content:e.slice(0,2e3)}],temperature:0})).choices[0].message.content.trim();return"null"===t?null:t}catch{return null}}extractProductType(e){let t=e.toLowerCase();for(let e of["roller shutter","door","window","glazing","curtain","blind"])if(t.includes(e))return e;return null}}let n=new a},49192:(e,t,r)=>{r.d(t,{q:()=>a});class s{loadAccessToken(){if(this.accessToken)return this.accessToken;let e=process.env.SHAREPOINT_ACCESS_TOKEN;if(!e)throw Error("SharePoint access token not found in environment variables");return this.accessToken=e,this.accessToken}async makeRequest(e,t="GET",r){let s=this.loadAccessToken(),a=`${this.baseURL}${e}`,n={method:t,headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}};r&&(n.body=JSON.stringify(r));let o=await fetch(a,n);if(!o.ok){let e=await o.text();throw Error(`Microsoft Graph API error: ${o.status} ${e}`)}return o.json()}async getSites(){return(await this.makeRequest("/sites?search=*")).value||[]}async getSite(e){return this.makeRequest(`/sites/${e}`)}async getSiteDrives(e){return(await this.makeRequest(`/sites/${e}/drives`)).value||[]}async getDriveItems(e,t,r){let s=`/sites/${e}/drives/${t}/root/children`;return r&&(s=`/sites/${e}/drives/${t}/root:/${r}:/children`),(await this.makeRequest(s)).value||[]}async getFileContent(e,t,r){let s=this.loadAccessToken(),a=`${this.baseURL}/sites/${e}/drives/${t}/items/${r}/content`,n=await fetch(a,{headers:{Authorization:`Bearer ${s}`}});if(!n.ok)throw Error(`Failed to fetch file content: ${n.status}`);return n.body}async getFileDownloadUrl(e,t,r){let s=await this.makeRequest(`/sites/${e}/drives/${t}/items/${r}`);return s["@microsoft.graph.downloadUrl"]||s.webUrl}async searchFiles(e,t){let r={requests:[{entityTypes:["driveItem"],query:{queryString:e},...t&&{sharePointOneDriveOptions:{siteId:t}}}]},s=await this.makeRequest("/search/query","POST",r);return(s.value?.[0]?.hitsContainers?.[0]?.hits||[]).map(e=>e.resource)}async getMyDrive(){return this.makeRequest("/me/drive")}async getRecentFiles(e=20){return(await this.makeRequest(`/me/drive/recent?$top=${e}`)).value||[]}async getSharedWithMe(){return(await this.makeRequest("/me/drive/sharedWithMe")).value||[]}constructor(){this.accessToken=null,this.baseURL="https://graph.microsoft.com/v1.0"}}let a=new s}};