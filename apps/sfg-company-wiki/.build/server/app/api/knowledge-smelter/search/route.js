"use strict";(()=>{var e={};e.id=2619,e.ids=[2619],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},6092:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>q,patchFetch:()=>_,requestAsyncStorage:()=>m,routeModule:()=>d,serverHooks:()=>g,staticGenerationAsyncStorage:()=>x});var s={};t.r(s),t.d(s,{GET:()=>c});var i=t(79182),n=t(72007),o=t(56719),a=t(93442),l=t(57978),u=t(19356),p=t(83178);async function c(e){if(!await (0,l.getServerSession)(await (0,u.d)()))return a.NextResponse.json({error:"Unauthorized"},{status:401});try{let{searchParams:r}=new URL(e.url),t=r.get("q"),s=r.get("jobNumber"),i=r.get("customer"),n=r.get("fileType"),o=parseInt(r.get("page")||"1"),l=parseInt(r.get("limit")||"20"),u={};t&&(u.OR=[{fileName:{contains:t,mode:"insensitive"}},{textContent:{contains:t,mode:"insensitive"}},{summary:{contains:t,mode:"insensitive"}}]),s&&(u.jobNumber=s),i&&(u.customerName={contains:i,mode:"insensitive"}),n&&(u.fileType=n);let[c,d]=await Promise.all([p._.archivedFile.findMany({where:u,include:{tags:!0,relationships:{include:{targetFile:!0}}},skip:(o-1)*l,take:l,orderBy:{createdAt:"desc"}}),p._.archivedFile.count({where:u})]);return a.NextResponse.json({files:c,pagination:{total:d,page:o,limit:l,pages:Math.ceil(d/l)}})}catch(e){return console.error("Search error:",e),a.NextResponse.json({error:"Search failed",details:e.message},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/knowledge-smelter/search/route",pathname:"/api/knowledge-smelter/search",filename:"route",bundlePath:"app/api/knowledge-smelter/search/route"},resolvedPagePath:"/home/ubuntu/company_wiki/nextjs_space/app/api/knowledge-smelter/search/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:m,staticGenerationAsyncStorage:x,serverHooks:g}=d,q="/api/knowledge-smelter/search/route";function _(){return(0,o.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:x})}},19356:(e,r,t)=>{t.d(r,{d:()=>g});var s=t(64617),i=t(66291),n=t(80207),o=t(3390),a=t.n(o),l=t(83178),u=t(29061),p=t(52075);let c=process.env.AZURE_KEY_VAULT_URL||"",d="true"===process.env.USE_AZURE_KEY_VAULT,m=null;async function x(e,r){let t=function(){if(!d||!c)return null;if(!m)try{let e;process.env.AZURE_CLIENT_ID&&process.env.AZURE_CLIENT_SECRET&&process.env.AZURE_TENANT_ID?e=new p.Rp(process.env.AZURE_TENANT_ID,process.env.AZURE_CLIENT_ID,process.env.AZURE_CLIENT_SECRET):e=new p.y0,m=new u.rx(c,e)}catch(e){return console.error("Failed to initialize Key Vault client:",e),null}return m}();if(!t){if(r){let e=process.env[r];return void 0!==e?e:null}return null}try{return(await t.getSecret(e)).value||null}catch(t){if(console.error(`Failed to get secret '${e}' from Key Vault:`,t),r){let e=process.env[r];return void 0!==e?e:null}return null}}async function g(){let e=[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=await l._.user.findUnique({where:{email:e.email}});return r&&r.password&&await a().compare(e.password,r.password)?{id:r.id,email:r.email,name:r.firstName?`${r.firstName} ${r.lastName||""}`.trim():r.email,role:r.role}:null}})],r=await x("sfg-wiki-entra-client-id","AZURE_AD_CLIENT_ID"),t=await x("sfg-wiki-entra-client-secret","AZURE_AD_CLIENT_SECRET"),o=await x("sfg-wiki-entra-tenant-id","AZURE_AD_TENANT_ID");return r&&t&&o&&e.push((0,n.Z)({clientId:r,clientSecret:t,tenantId:o,authorization:{params:{scope:"openid profile email User.Read"}}})),{adapter:(0,s.N)(l._),providers:e,session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="azure-ad")try{await l._.user.findUnique({where:{email:e.email}})||await l._.user.create({data:{email:e.email,firstName:t?.given_name||e.name?.split(" ")[0]||"",lastName:t?.family_name||e.name?.split(" ").slice(1).join(" ")||"",role:"USER",password:null}})}catch(e){return console.error("Error during Azure AD sign-in:",e),!1}return!0},jwt:async({token:e,user:r,account:t,profile:s})=>(r&&(e.role=r.role),t?.provider==="azure-ad"&&s&&(e.groups=s.groups||[],s.roles&&(s.roles.includes("SFG-Wiki-Admin")?e.role="ADMIN":s.roles.includes("SFG-Wiki-Approver")?e.role="APPROVER":s.roles.includes("SFG-Wiki-Editor")?e.role="EDITOR":s.roles.includes("SFG-Wiki-Viewer")&&(e.role="USER"))),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role,e.user.groups=r.groups||[]),e)}}}},83178:(e,r,t)=>{t.d(r,{_:()=>i});var s=t(53524);let i=globalThis.prisma??new s.PrismaClient}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4372,7329,4958,7609,4317],()=>t(6092));module.exports=s})();