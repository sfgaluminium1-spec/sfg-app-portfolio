"use strict";(()=>{var e={};e.id=5730,e.ids=[5730],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},74286:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>g,staticGenerationAsyncStorage:()=>f});var i={};t.r(i),t.d(i,{GET:()=>c});var s=t(79182),n=t(72007),a=t(56719),o=t(93442),l=t(57978),u=t(19356),p=t(83178),d=t(24041);async function c(e,{params:r}){if(!await (0,l.getServerSession)(await (0,u.d)()))return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=await p._.archivedFile.findUnique({where:{id:r.id},include:{tags:!0,batch:!0}});if(!e)return o.NextResponse.json({error:"File not found"},{status:404});let t=await d.n.getFileRelationships(r.id);return o.NextResponse.json({...e,relationships:t})}catch(e){return console.error("Get file error:",e),o.NextResponse.json({error:"Failed to get file",details:e.message},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/knowledge-smelter/files/[id]/route",pathname:"/api/knowledge-smelter/files/[id]",filename:"route",bundlePath:"app/api/knowledge-smelter/files/[id]/route"},resolvedPagePath:"/home/ubuntu/company_wiki/nextjs_space/app/api/knowledge-smelter/files/[id]/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:g}=h,w="/api/knowledge-smelter/files/[id]/route";function x(){return(0,a.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:f})}},19356:(e,r,t)=>{t.d(r,{d:()=>f});var i=t(64617),s=t(66291),n=t(80207),a=t(3390),o=t.n(a),l=t(83178),u=t(29061),p=t(52075);let d=process.env.AZURE_KEY_VAULT_URL||"",c="true"===process.env.USE_AZURE_KEY_VAULT,h=null;async function m(e,r){let t=function(){if(!c||!d)return null;if(!h)try{let e;process.env.AZURE_CLIENT_ID&&process.env.AZURE_CLIENT_SECRET&&process.env.AZURE_TENANT_ID?e=new p.Rp(process.env.AZURE_TENANT_ID,process.env.AZURE_CLIENT_ID,process.env.AZURE_CLIENT_SECRET):e=new p.y0,h=new u.rx(d,e)}catch(e){return console.error("Failed to initialize Key Vault client:",e),null}return h}();if(!t){if(r){let e=process.env[r];return void 0!==e?e:null}return null}try{return(await t.getSecret(e)).value||null}catch(t){if(console.error(`Failed to get secret '${e}' from Key Vault:`,t),r){let e=process.env[r];return void 0!==e?e:null}return null}}async function f(){let e=[(0,s.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=await l._.user.findUnique({where:{email:e.email}});return r&&r.password&&await o().compare(e.password,r.password)?{id:r.id,email:r.email,name:r.firstName?`${r.firstName} ${r.lastName||""}`.trim():r.email,role:r.role}:null}})],r=await m("sfg-wiki-entra-client-id","AZURE_AD_CLIENT_ID"),t=await m("sfg-wiki-entra-client-secret","AZURE_AD_CLIENT_SECRET"),a=await m("sfg-wiki-entra-tenant-id","AZURE_AD_TENANT_ID");return r&&t&&a&&e.push((0,n.Z)({clientId:r,clientSecret:t,tenantId:a,authorization:{params:{scope:"openid profile email User.Read"}}})),{adapter:(0,i.N)(l._),providers:e,session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="azure-ad")try{await l._.user.findUnique({where:{email:e.email}})||await l._.user.create({data:{email:e.email,firstName:t?.given_name||e.name?.split(" ")[0]||"",lastName:t?.family_name||e.name?.split(" ").slice(1).join(" ")||"",role:"USER",password:null}})}catch(e){return console.error("Error during Azure AD sign-in:",e),!1}return!0},jwt:async({token:e,user:r,account:t,profile:i})=>(r&&(e.role=r.role),t?.provider==="azure-ad"&&i&&(e.groups=i.groups||[],i.roles&&(i.roles.includes("SFG-Wiki-Admin")?e.role="ADMIN":i.roles.includes("SFG-Wiki-Approver")?e.role="APPROVER":i.roles.includes("SFG-Wiki-Editor")?e.role="EDITOR":i.roles.includes("SFG-Wiki-Viewer")&&(e.role="USER"))),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role,e.user.groups=r.groups||[]),e)}}}},83178:(e,r,t)=>{t.d(r,{_:()=>s});var i=t(53524);let s=globalThis.prisma??new i.PrismaClient},24041:(e,r,t)=>{t.d(r,{n:()=>a});var i=t(83178),s=t(53524);class n{async discoverRelationships(e){let r=await i._.archivedFile.findUnique({where:{id:e},include:{tags:!0}});if(!r)return[];let t=[];return r.jobNumber&&t.push(...await this.findJobRelationships(e,r.jobNumber)),t.push(...await this.findVersionRelationships(e,r.fileName)),r.customerName&&t.push(...await this.findCustomerRelationships(e,r.customerName)),t}async findJobRelationships(e,r){return(await i._.archivedFile.findMany({where:{jobNumber:r,id:{not:e}},take:50})).map(t=>({sourceFileId:e,targetFileId:t.id,type:s.RelationshipType.RELATED_TO_JOB,strength:8,reason:`Both files belong to job ${r}`}))}async findVersionRelationships(e,r){let t=[],n=r.match(/(.*?)[-_]?v?(\d+)(\.[^.]+)?$/i);if(!n)return[];let a=n[1],o=parseInt(n[2]);for(let r of(await i._.archivedFile.findMany({where:{fileName:{contains:a,mode:"insensitive"},id:{not:e}}}))){let i=r.fileName.match(/(.*?)[-_]?v?(\d+)(\.[^.]+)?$/i);if(i){let n=parseInt(i[2]);n<o?t.push({sourceFileId:e,targetFileId:r.id,type:s.RelationshipType.VERSION_OF,strength:9,reason:`Version ${o} supersedes version ${n}`}):n>o&&t.push({sourceFileId:r.id,targetFileId:e,type:s.RelationshipType.VERSION_OF,strength:9,reason:`Version ${n} supersedes version ${o}`})}}return t}async findCustomerRelationships(e,r){return(await i._.archivedFile.findMany({where:{customerName:{contains:r,mode:"insensitive"},id:{not:e}},take:20})).map(t=>({sourceFileId:e,targetFileId:t.id,type:s.RelationshipType.RELATED_TO_JOB,strength:6,reason:`Both files related to customer ${r}`}))}async createRelationships(e){let r=0;for(let t of e)try{await i._.fileRelationship.create({data:{sourceFileId:t.sourceFileId,targetFileId:t.targetFileId,relationshipType:t.type,strength:t.strength,description:t.reason}}),r++}catch(e){continue}return r}async getFileRelationships(e){let[r,t]=await Promise.all([i._.fileRelationship.findMany({where:{sourceFileId:e},include:{targetFile:!0}}),i._.fileRelationship.findMany({where:{targetFileId:e},include:{sourceFile:!0}})]);return{outgoing:r,incoming:t}}async reconstructJobFolder(e){let r=await i._.archivedFile.findMany({where:{jobNumber:e},include:{tags:!0,relationships:{include:{targetFile:!0}}},orderBy:{createdAt:"asc"}});return{jobNumber:e,fileCount:r.length,files:r,totalSize:r.reduce((e,r)=>e+Number(r.fileSize),0)}}}let a=new n}};var r=require("../../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),i=r.X(0,[4372,7329,4958,7609,4317],()=>t(74286));module.exports=i})();