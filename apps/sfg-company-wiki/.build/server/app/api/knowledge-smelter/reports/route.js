"use strict";(()=>{var e={};e.id=199,e.ids=[199],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},14134:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>q});var i={};r.r(i),r.d(i,{GET:()=>f});var s=r(79182),o=r(72007),n=r(56719),a=r(93442),c=r(57978),u=r(19356),l=r(83178),p=r(36396),d=r(47887);async function f(e){if(!await (0,c.getServerSession)(await (0,u.d)()))return a.NextResponse.json({error:"Unauthorized"},{status:401});try{let{searchParams:t}=new URL(e.url);switch(t.get("type")||"summary"){case"summary":return a.NextResponse.json(await g());case"batch":let r=t.get("batchId");if(!r)return a.NextResponse.json({error:"batchId required"},{status:400});return a.NextResponse.json(await h(r));case"classification":return a.NextResponse.json(await x());default:return a.NextResponse.json({error:"Invalid report type"},{status:400})}}catch(e){return console.error("Report generation error:",e),a.NextResponse.json({error:"Failed to generate report",details:e.message},{status:500})}}async function g(){let[e,t,r,i,s,o,n]=await Promise.all([l._.archivedFile.count(),l._.archivedFile.aggregate({_sum:{fileSize:!0}}),l._.archivedFile.groupBy({by:["processingStatus"],_count:!0}),l._.archivedFile.groupBy({by:["fileType"],_count:!0}),Promise.all([l._.archivedFile.count({where:{confidence:{gte:85}}}),l._.archivedFile.count({where:{confidence:{gte:50,lt:85}}}),l._.archivedFile.count({where:{confidence:{lt:50}}})]),p.t.getTagStats(),d.n.getScanStats()]);return{overview:{totalFiles:e,totalSizeGB:Number(t._sum.fileSize||0)/1073741824,processingComplete:r.find(e=>"COMPLETED"===e.processingStatus)?._count||0},processingStatus:r,fileTypes:i,confidence:{high:s[0],medium:s[1],low:s[2]},tags:o,scan:n,generatedAt:new Date().toISOString()}}async function h(e){let t=await l._.processingBatch.findUnique({where:{id:e},include:{files:{include:{tags:!0}}}});if(!t)throw Error("Batch not found");let r=t.files.reduce((e,t)=>(e[t.fileType]=(e[t.fileType]||0)+1,e),{}),i=t.files.reduce((e,t)=>e+t.confidence,0)/t.files.length;return{batch:{id:t.id,name:t.batchName,status:t.status,startedAt:t.startedAt,completedAt:t.completedAt,duration:t.actualDuration},statistics:{totalFiles:t.filesQueued,processed:t.filesProcessed,succeeded:t.filesSucceeded,failed:t.filesFailed,averageConfidence:i},fileTypes:r,generatedAt:new Date().toISOString()}}async function x(){let e=await l._.archivedFile.findMany({select:{fileType:!0,confidence:!0,classificationMethod:!0}}),t=e.reduce((e,t)=>(e[t.classificationMethod]=(e[t.classificationMethod]||0)+1,e),{}),r={"0-25":0,"26-50":0,"51-75":0,"76-85":0,"86-100":0};return e.forEach(e=>{e.confidence<=25?r["0-25"]++:e.confidence<=50?r["26-50"]++:e.confidence<=75?r["51-75"]++:e.confidence<=85?r["76-85"]++:r["86-100"]++}),{totalFiles:e.length,byMethod:t,confidenceDistribution:r,averageConfidence:e.reduce((e,t)=>e+t.confidence,0)/e.length,generatedAt:new Date().toISOString()}}let m=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/knowledge-smelter/reports/route",pathname:"/api/knowledge-smelter/reports",filename:"route",bundlePath:"app/api/knowledge-smelter/reports/route"},resolvedPagePath:"/home/ubuntu/company_wiki/nextjs_space/app/api/knowledge-smelter/reports/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:y,staticGenerationAsyncStorage:q,serverHooks:w}=m,v="/api/knowledge-smelter/reports/route";function S(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:q})}},47887:(e,t,r)=>{r.d(t,{n:()=>a});var i=r(49192),s=r(83178),o=r(53524);class n{async scanSites(){let e=await i.q.getSites(),t={sites:[],totalFiles:0,totalSize:0};for(let r of e){let e=await i.q.getSiteDrives(r.id),s={id:r.id,name:r.displayName,url:r.webUrl,drives:[]};for(let o of e)try{let e=await i.q.getDriveItems(r.id,o.id),n=e.filter(e=>!e.folder).length,a=e.reduce((e,t)=>e+(t.size||0),0);s.drives.push({id:o.id,name:o.name,fileCount:n}),t.totalFiles+=n,t.totalSize+=a}catch(e){console.error(`Error scanning drive ${o.id}:`,e)}t.sites.push(s)}return t}async scanAndQueueFiles(e,t,r,i={}){let n=await this.scanDriveRecursively(e,t,i),a=0;for(let e of n)if(!(i.skipExisting&&await s._.archivedFile.findFirst({where:{sharePointItemId:e.id}}))&&(await s._.archivedFile.create({data:{fileName:e.name,originalPath:e.webUrl,fileExtension:e.name.split(".").pop()||"",fileSize:BigInt(e.size),mimeType:e.file?.mimeType||"application/octet-stream",cloudStoragePath:"",sharePointUrl:e.webUrl,sharePointDriveId:t,sharePointItemId:e.id,fileType:"UNCLASSIFIED",confidence:0,retentionYears:7,processingStatus:o.ProcessingStatus.PENDING,batchId:r}}),a++,i.maxFiles&&a>=i.maxFiles))break;return a}async scanDriveRecursively(e,t,r,s=""){let o=await i.q.getDriveItems(e,t,s),n=[];for(let i of o)if(i.folder){let o=s?`${s}/${i.name}`:i.name,a=await this.scanDriveRecursively(e,t,r,o);n=n.concat(a)}else{if(r.fileExtensions){let e=i.name.split(".").pop()?.toLowerCase();if(e&&!r.fileExtensions.includes(`.${e}`))continue}n.push(i)}return n}async getScanStats(){let e=await s._.archivedFile.count(),t=await s._.archivedFile.groupBy({by:["processingStatus"],_count:!0}),r=await s._.archivedFile.groupBy({by:["fileType"],_count:!0});return{total:e,byStatus:t.reduce((e,t)=>(e[t.processingStatus]=t._count,e),{}),byType:r.reduce((e,t)=>(e[t.fileType]=t._count,e),{})}}}let a=new n}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[4372,7329,4958,7609,4317,9187,1965],()=>r(14134));module.exports=i})();