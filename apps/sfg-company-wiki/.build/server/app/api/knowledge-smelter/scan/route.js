"use strict";(()=>{var e={};e.id=7938,e.ids=[7938],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},72254:e=>{e.exports=require("node:buffer")},17718:e=>{e.exports=require("node:child_process")},6005:e=>{e.exports=require("node:crypto")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},22286:e=>{e.exports=require("node:https")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},97742:e=>{e.exports=require("node:process")},84492:e=>{e.exports=require("node:stream")},41041:e=>{e.exports=require("node:url")},47261:e=>{e.exports=require("node:util")},65628:e=>{e.exports=require("node:zlib")},34793:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>v,patchFetch:()=>g,requestAsyncStorage:()=>h,routeModule:()=>m,serverHooks:()=>w,staticGenerationAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{GET:()=>p,POST:()=>d});var i=t(79182),a=t(72007),n=t(56719),o=t(93442),l=t(57978),u=t(19356),c=t(47887);async function p(e){if(!await (0,l.getServerSession)(await (0,u.d)()))return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let e=await c.n.scanSites();return o.NextResponse.json(e)}catch(e){return console.error("Scan error:",e),o.NextResponse.json({error:"Failed to scan SharePoint sites",details:e.message},{status:500})}}async function d(e){if(!await (0,l.getServerSession)(await (0,u.d)()))return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let{siteId:r,driveId:t,batchId:s,maxFiles:i,skipExisting:a}=await e.json();if(!r||!t||!s)return o.NextResponse.json({error:"Missing required fields: siteId, driveId, batchId"},{status:400});let n=await c.n.scanAndQueueFiles(r,t,s,{maxFiles:i,skipExisting:!1!==a});return o.NextResponse.json({success:!0,queuedCount:n,message:`Queued ${n} files for processing`})}catch(e){return console.error("Queue error:",e),o.NextResponse.json({error:"Failed to queue files",details:e.message},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/knowledge-smelter/scan/route",pathname:"/api/knowledge-smelter/scan",filename:"route",bundlePath:"app/api/knowledge-smelter/scan/route"},resolvedPagePath:"/home/ubuntu/company_wiki/nextjs_space/app/api/knowledge-smelter/scan/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:f,serverHooks:w}=m,v="/api/knowledge-smelter/scan/route";function g(){return(0,n.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:f})}},19356:(e,r,t)=>{t.d(r,{d:()=>f});var s=t(64617),i=t(66291),a=t(80207),n=t(3390),o=t.n(n),l=t(83178),u=t(29061),c=t(52075);let p=process.env.AZURE_KEY_VAULT_URL||"",d="true"===process.env.USE_AZURE_KEY_VAULT,m=null;async function h(e,r){let t=function(){if(!d||!p)return null;if(!m)try{let e;process.env.AZURE_CLIENT_ID&&process.env.AZURE_CLIENT_SECRET&&process.env.AZURE_TENANT_ID?e=new c.Rp(process.env.AZURE_TENANT_ID,process.env.AZURE_CLIENT_ID,process.env.AZURE_CLIENT_SECRET):e=new c.y0,m=new u.rx(p,e)}catch(e){return console.error("Failed to initialize Key Vault client:",e),null}return m}();if(!t){if(r){let e=process.env[r];return void 0!==e?e:null}return null}try{return(await t.getSecret(e)).value||null}catch(t){if(console.error(`Failed to get secret '${e}' from Key Vault:`,t),r){let e=process.env[r];return void 0!==e?e:null}return null}}async function f(){let e=[(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let r=await l._.user.findUnique({where:{email:e.email}});return r&&r.password&&await o().compare(e.password,r.password)?{id:r.id,email:r.email,name:r.firstName?`${r.firstName} ${r.lastName||""}`.trim():r.email,role:r.role}:null}})],r=await h("sfg-wiki-entra-client-id","AZURE_AD_CLIENT_ID"),t=await h("sfg-wiki-entra-client-secret","AZURE_AD_CLIENT_SECRET"),n=await h("sfg-wiki-entra-tenant-id","AZURE_AD_TENANT_ID");return r&&t&&n&&e.push((0,a.Z)({clientId:r,clientSecret:t,tenantId:n,authorization:{params:{scope:"openid profile email User.Read"}}})),{adapter:(0,s.N)(l._),providers:e,session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="azure-ad")try{await l._.user.findUnique({where:{email:e.email}})||await l._.user.create({data:{email:e.email,firstName:t?.given_name||e.name?.split(" ")[0]||"",lastName:t?.family_name||e.name?.split(" ").slice(1).join(" ")||"",role:"USER",password:null}})}catch(e){return console.error("Error during Azure AD sign-in:",e),!1}return!0},jwt:async({token:e,user:r,account:t,profile:s})=>(r&&(e.role=r.role),t?.provider==="azure-ad"&&s&&(e.groups=s.groups||[],s.roles&&(s.roles.includes("SFG-Wiki-Admin")?e.role="ADMIN":s.roles.includes("SFG-Wiki-Approver")?e.role="APPROVER":s.roles.includes("SFG-Wiki-Editor")?e.role="EDITOR":s.roles.includes("SFG-Wiki-Viewer")&&(e.role="USER"))),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.sub,e.user.role=r.role,e.user.groups=r.groups||[]),e)}}}},83178:(e,r,t)=>{t.d(r,{_:()=>i});var s=t(53524);let i=globalThis.prisma??new s.PrismaClient},47887:(e,r,t)=>{t.d(r,{n:()=>o});var s=t(49192),i=t(83178),a=t(53524);class n{async scanSites(){let e=await s.q.getSites(),r={sites:[],totalFiles:0,totalSize:0};for(let t of e){let e=await s.q.getSiteDrives(t.id),i={id:t.id,name:t.displayName,url:t.webUrl,drives:[]};for(let a of e)try{let e=await s.q.getDriveItems(t.id,a.id),n=e.filter(e=>!e.folder).length,o=e.reduce((e,r)=>e+(r.size||0),0);i.drives.push({id:a.id,name:a.name,fileCount:n}),r.totalFiles+=n,r.totalSize+=o}catch(e){console.error(`Error scanning drive ${a.id}:`,e)}r.sites.push(i)}return r}async scanAndQueueFiles(e,r,t,s={}){let n=await this.scanDriveRecursively(e,r,s),o=0;for(let e of n)if(!(s.skipExisting&&await i._.archivedFile.findFirst({where:{sharePointItemId:e.id}}))&&(await i._.archivedFile.create({data:{fileName:e.name,originalPath:e.webUrl,fileExtension:e.name.split(".").pop()||"",fileSize:BigInt(e.size),mimeType:e.file?.mimeType||"application/octet-stream",cloudStoragePath:"",sharePointUrl:e.webUrl,sharePointDriveId:r,sharePointItemId:e.id,fileType:"UNCLASSIFIED",confidence:0,retentionYears:7,processingStatus:a.ProcessingStatus.PENDING,batchId:t}}),o++,s.maxFiles&&o>=s.maxFiles))break;return o}async scanDriveRecursively(e,r,t,i=""){let a=await s.q.getDriveItems(e,r,i),n=[];for(let s of a)if(s.folder){let a=i?`${i}/${s.name}`:s.name,o=await this.scanDriveRecursively(e,r,t,a);n=n.concat(o)}else{if(t.fileExtensions){let e=s.name.split(".").pop()?.toLowerCase();if(e&&!t.fileExtensions.includes(`.${e}`))continue}n.push(s)}return n}async getScanStats(){let e=await i._.archivedFile.count(),r=await i._.archivedFile.groupBy({by:["processingStatus"],_count:!0}),t=await i._.archivedFile.groupBy({by:["fileType"],_count:!0});return{total:e,byStatus:r.reduce((e,r)=>(e[r.processingStatus]=r._count,e),{}),byType:t.reduce((e,r)=>(e[r.fileType]=r._count,e),{})}}}let o=new n},49192:(e,r,t)=>{t.d(r,{q:()=>i});class s{loadAccessToken(){if(this.accessToken)return this.accessToken;let e=process.env.SHAREPOINT_ACCESS_TOKEN;if(!e)throw Error("SharePoint access token not found in environment variables");return this.accessToken=e,this.accessToken}async makeRequest(e,r="GET",t){let s=this.loadAccessToken(),i=`${this.baseURL}${e}`,a={method:r,headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/json"}};t&&(a.body=JSON.stringify(t));let n=await fetch(i,a);if(!n.ok){let e=await n.text();throw Error(`Microsoft Graph API error: ${n.status} ${e}`)}return n.json()}async getSites(){return(await this.makeRequest("/sites?search=*")).value||[]}async getSite(e){return this.makeRequest(`/sites/${e}`)}async getSiteDrives(e){return(await this.makeRequest(`/sites/${e}/drives`)).value||[]}async getDriveItems(e,r,t){let s=`/sites/${e}/drives/${r}/root/children`;return t&&(s=`/sites/${e}/drives/${r}/root:/${t}:/children`),(await this.makeRequest(s)).value||[]}async getFileContent(e,r,t){let s=this.loadAccessToken(),i=`${this.baseURL}/sites/${e}/drives/${r}/items/${t}/content`,a=await fetch(i,{headers:{Authorization:`Bearer ${s}`}});if(!a.ok)throw Error(`Failed to fetch file content: ${a.status}`);return a.body}async getFileDownloadUrl(e,r,t){let s=await this.makeRequest(`/sites/${e}/drives/${r}/items/${t}`);return s["@microsoft.graph.downloadUrl"]||s.webUrl}async searchFiles(e,r){let t={requests:[{entityTypes:["driveItem"],query:{queryString:e},...r&&{sharePointOneDriveOptions:{siteId:r}}}]},s=await this.makeRequest("/search/query","POST",t);return(s.value?.[0]?.hitsContainers?.[0]?.hits||[]).map(e=>e.resource)}async getMyDrive(){return this.makeRequest("/me/drive")}async getRecentFiles(e=20){return(await this.makeRequest(`/me/drive/recent?$top=${e}`)).value||[]}async getSharedWithMe(){return(await this.makeRequest("/me/drive/sharedWithMe")).value||[]}constructor(){this.accessToken=null,this.baseURL="https://graph.microsoft.com/v1.0"}}let i=new s}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4372,7329,4958,7609,4317],()=>t(34793));module.exports=s})();