generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
    output = "/home/ubuntu/company_wiki/nextjs_space/node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Authentication and User Management
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String?
  firstName     String?
  lastName      String?
  role          UserRole  @default(USER)
  tierLevel     String?
  department    String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  emailVerified DateTime?
  image         String?

  accounts            Account[]
  sessions            Session[]
  procedures          Procedure[]
  auditLogs           AuditLog[]
  conflictReports     ConflictReport[]
  chatSessions        ChatSession[]
  projects            Project[]
  productCountLogs    ProductCountLog[]
  approvedDocuments   ApprovedDocument[]
  projectAttachments  ProjectAttachment[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

// Core Knowledge Management
model Category {
  id           String      @id @default(cuid())
  name         String      @unique
  code         String?     @unique
  description  String?
  icon         String?
  color        String?
  sortOrder    Int         @default(0)
  isActive     Boolean     @default(true)
  parentId     String?
  parent       Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[]  @relation("CategoryHierarchy")
  procedures   Procedure[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@map("categories")
}

model Procedure {
  id               String           @id @default(cuid())
  title            String
  content          String           @db.Text
  summary          String?
  categoryId       String
  category         Category         @relation(fields: [categoryId], references: [id])
  tags             String[]         @default([])
  priority         Priority         @default(MEDIUM)
  status           ProcedureStatus  @default(ACTIVE)
  version          Int              @default(1)
  isLatestVersion  Boolean          @default(true)
  originalId       String?          // Links to original procedure for versions
  formulas         String[]         @default([])
  thresholds       Json?            // Store structured threshold data
  dependencies     String[]         @default([]) // IDs of dependent procedures
  approvalLevel    ApprovalLevel    @default(NONE)
  effectiveDate    DateTime?
  expirationDate   DateTime?
  
  // Metadata
  createdById      String
  createdBy        User             @relation(fields: [createdById], references: [id])
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  
  // Related entities
  conflicts        ConflictReport[] @relation("ProcedureConflicts")
  relatedConflicts ConflictReport[] @relation("RelatedProcedureConflicts")
  crossReferences  CrossReference[] @relation("SourceProcedure")
  referencedIn     CrossReference[] @relation("TargetProcedure")
  auditLogs        AuditLog[]
  attachments      Attachment[]

  @@map("procedures")
  @@index([categoryId])
  @@index([status])
  @@index([isLatestVersion])
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ProcedureStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
  UNDER_REVIEW
}

enum ApprovalLevel {
  NONE
  MANAGER
  DIRECTOR
  VP
  CEO
}

// Cross-referencing and Relationships
model CrossReference {
  id                  String   @id @default(cuid())
  sourceProcedureId   String
  sourceProcedure     Procedure @relation("SourceProcedure", fields: [sourceProcedureId], references: [id], onDelete: Cascade)
  targetProcedureId   String
  targetProcedure     Procedure @relation("TargetProcedure", fields: [targetProcedureId], references: [id], onDelete: Cascade)
  relationshipType    CrossRefType
  description         String?
  strength            Int      @default(5) // 1-10 scale
  createdAt           DateTime @default(now())

  @@map("cross_references")
  @@unique([sourceProcedureId, targetProcedureId])
}

enum CrossRefType {
  DEPENDS_ON
  CONFLICTS_WITH
  RELATED_TO
  OVERRIDES
  SUPPLEMENTS
  REFERENCES
}

// Conflict Detection System
model ConflictReport {
  id               String        @id @default(cuid())
  title            String
  description      String        @db.Text
  conflictType     ConflictType
  severity         ConflictSeverity
  status           ConflictStatus @default(DETECTED)
  
  procedureId      String
  procedure        Procedure     @relation("ProcedureConflicts", fields: [procedureId], references: [id])
  relatedProcedureId String?
  relatedProcedure Procedure?    @relation("RelatedProcedureConflicts", fields: [relatedProcedureId], references: [id])
  
  detectedAt       DateTime      @default(now())
  resolvedAt       DateTime?
  resolution       String?       @db.Text
  
  reportedById     String
  reportedBy       User          @relation(fields: [reportedById], references: [id])
  
  @@map("conflict_reports")
  @@index([status])
  @@index([severity])
}

enum ConflictType {
  DUPLICATE_RULE
  CONTRADICTORY_POLICY
  OVERLAPPING_AUTHORITY
  INCONSISTENT_FORMULA
  MISALIGNED_THRESHOLD
  CIRCULAR_DEPENDENCY
  OTHER
}

enum ConflictSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ConflictStatus {
  DETECTED
  INVESTIGATING
  RESOLVED
  ACCEPTED
  IGNORED
}

// File Management and Attachments
model Attachment {
  id            String   @id @default(cuid())
  fileName      String
  originalName  String
  fileSize      BigInt
  mimeType      String
  cloudStoragePath String
  procedureId   String
  procedure     Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  uploadedAt    DateTime @default(now())

  @@map("attachments")
}

// Audit Trail System
model AuditLog {
  id          String     @id @default(cuid())
  action      AuditAction
  entityType  String     // "procedure", "category", "conflict", etc.
  entityId    String
  oldValues   Json?      // Store previous values
  newValues   Json?      // Store new values
  description String?
  ipAddress   String?
  userAgent   String?
  
  userId      String
  user        User       @relation(fields: [userId], references: [id])
  procedureId String?
  procedure   Procedure? @relation(fields: [procedureId], references: [id])
  
  createdAt   DateTime   @default(now())

  @@map("audit_logs")
  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  APPROVE
  REJECT
  RESTORE
  ARCHIVE
}

// RAG Chatbot System
model ChatSession {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  title     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  ChatMessage[]

  @@map("chat_sessions")
}

model ChatMessage {
  id            String      @id @default(cuid())
  sessionId     String
  session       ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          MessageRole
  content       String      @db.Text
  metadata      Json?       // Store additional context, sources, etc.
  createdAt     DateTime    @default(now())

  @@map("chat_messages")
  @@index([sessionId])
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Import/Export Tracking
model ImportJob {
  id          String     @id @default(cuid())
  fileName    String
  fileSize    BigInt
  totalRows   Int?
  processedRows Int      @default(0)
  successRows Int        @default(0)
  errorRows   Int        @default(0)
  status      ImportStatus @default(PENDING)
  errors      Json?      // Store error details
  results     Json?      // Store import results/summary
  createdAt   DateTime   @default(now())
  completedAt DateTime?

  @@map("import_jobs")
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// Company-Specific Data Models (Based on Audit Questionnaire)

// Staff Tier Levels
model StaffTier {
  id                String   @id @default(cuid())
  name              String   @unique
  level             Int      @unique
  description       String?
  salaryMin         Decimal? @db.Decimal(10,2)
  salaryMax         Decimal? @db.Decimal(10,2)
  reportsTo         String?
  managesLevels     String[] @default([])
  budgetAuthority   Decimal? @db.Decimal(10,2)
  approvalLimits    Json?    // Store various approval limits
  systemPermissions Json?    // Store system access permissions
  benefits          Json?    // Store tier-specific benefits
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("staff_tiers")
}

// Customer Tier Levels
model CustomerTier {
  id                    String   @id @default(cuid())
  name                  String   @unique
  code                  String?  @unique
  priority              Int      @default(1)
  revenueMin            Decimal? @db.Decimal(12,2)
  revenueMax            Decimal? @db.Decimal(12,2)
  transactionVolume     Int?
  contractLength        Int?     // in months
  creditRating          String?
  discountPercentage    Decimal? @db.Decimal(5,2)
  paymentTerms          String?
  creditLimit           Decimal? @db.Decimal(12,2)
  benefits              Json?    // Store tier benefits and privileges
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customer_tiers")
}

// Credit Check Protocols
model CreditCheckProtocol {
  id               String   @id @default(cuid())
  name             String   @unique
  triggerCondition String   // When credit check is required
  checkType        String[] @default([]) // Types of checks performed
  minimumScore     Int?
  scoringFormula   String?  @db.Text
  redFlags         String[] @default([])
  warningThresholds Json?
  approvalProcess  Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("credit_check_protocols")
}

// Pricing and Margin Rules
model PricingRule {
  id                String   @id @default(cuid())
  name              String   @unique
  category          String
  pricingMethod     String   // cost-plus, value-based, etc.
  baseFormula       String?  @db.Text
  markupPercentage  Decimal? @db.Decimal(5,2)
  minimumMargin     Decimal? @db.Decimal(5,2)
  discountRules     Json?    // Volume, tier, promotional discounts
  approvalLevels    Json?    // Approval thresholds
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("pricing_rules")
}

// Payroll Formulas
model PayrollFormula {
  id               String   @id @default(cuid())
  name             String   @unique
  category         String   // overtime, bonus, deduction, etc.
  formula          String   @db.Text
  parameters       Json?    // Formula parameters and variables
  applicableTo     String[] @default([]) // Employee types/tiers
  effectiveDate    DateTime?
  expirationDate   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payroll_formulas")
}

// Project Numbering System
model ProjectNumbering {
  id            String   @id @default(cuid())
  format        String   @unique // e.g., "PRJ-YYYY-CAT-###"
  description   String?
  categories    Json?    // Project categories and codes
  nextNumber    Int      @default(1)
  prefix        String?
  yearReset     Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("project_numbering")
}

// SFG Project Management System
model Project {
  id                    String          @id @default(cuid())
  baseNumber            String          @unique  // Immutable, e.g., "10001"
  prefix                ProjectPrefix   @default(ENQ)
  
  // Required fields for stage progression
  customer              String?
  project               String?
  location              String?
  productType           String?
  deliveryType          DeliveryType?
  customerOrderNumber   String?
  
  // Status and lifecycle
  status                ProjectStatus   @default(ENQ)
  statusColor           String          @default("White")
  
  // Product count tracking
  enquiryInitialCount   Int?
  currentProductCount   Int?
  preparedCount         Int             @default(0)
  deliveredCount        Int             @default(0)
  collectedCount        Int             @default(0)
  
  // Xero integration
  xeroContactId         String?
  xeroInvoiceId         String?
  xeroInvoiceNumber     String?
  
  // Drawing workflow state
  drawingWorkflowState  Json?           // Track 05a→05e progression
  approvedDrawings      String[]        @default([])
  
  // SharePoint paths
  canonicalPath         String?
  monthShortcutPath     String?
  
  // Lifecycle timestamps
  enquiryDate           DateTime        @default(now())
  quoteDate             DateTime?
  orderDate             DateTime?
  invoiceDate           DateTime?
  deliveryDate          DateTime?
  paidDate              DateTime?
  completedDate         DateTime?
  
  // Metadata
  notes                 String?         @db.Text
  tags                  String[]        @default([])
  priority              Priority        @default(MEDIUM)
  
  // Relationships
  productCountLogs      ProductCountLog[]
  deliveryNotes         DeliveryNote[]
  approvedDocuments     ApprovedDocument[]
  projectAttachments    ProjectAttachment[]
  
  createdById           String
  createdBy             User            @relation(fields: [createdById], references: [id])
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  @@map("projects")
  @@index([baseNumber])
  @@index([status])
  @@index([customer])
  @@index([xeroContactId])
}

enum ProjectPrefix {
  ENQ
  QUO
  ORD
  INV
  DEL
  PAID
}

enum ProjectStatus {
  ENQ      // White - Enquiry
  QUO      // Blue - Quote
  ORD      // Amber - Order
  INV      // Purple - Invoice
  DEL      // Navy - Delivered
  PAID     // Green - Paid
  MISSING  // Red badge - Missing required fields
}

enum DeliveryType {
  SUPPLY_ONLY
  COLLECTED
  SUPPLY_AND_INSTALL
}

// Product Count Change Log
model ProductCountLog {
  id                    String   @id @default(cuid())
  projectId             String
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  source                String   // "ENQ", "QUO_rev1", "Manual", etc.
  oldCount              Int?
  newCount              Int
  delta                 Int      @default(0)
  
  additions             String[] @default([])
  removals              String[] @default([])
  extras                String[] @default([])
  
  note                  String?  @db.Text
  pricingStatus         String?  // "Agreed", "Pricing Needed"
  
  estimatorSignoff      Boolean  @default(false)
  estimatorSignedBy     String?
  estimatorSignedAt     DateTime?
  
  financeAcknowledged   Boolean  @default(false)
  financeAcknowledgedBy String?
  financeAcknowledgedAt DateTime?
  
  createdById           String
  createdBy             User     @relation(fields: [createdById], references: [id])
  createdAt             DateTime @default(now())

  @@map("product_count_logs")
  @@index([projectId])
}

// Delivery and Collection Notes
model DeliveryNote {
  id                String           @id @default(cuid())
  projectId         String
  project           Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type              DeliveryNoteType
  noteNumber        String           @unique
  
  // Note content
  items             Json             // Array of {lineId, productType, description, qty, notes}
  
  // Status
  prepared          Boolean          @default(false)
  signed            Boolean          @default(false)
  
  // Signature details
  signedBy          String?
  signedCompany     String?
  signedDate        DateTime?
  signedTime        String?
  signedBadge       String?
  signatureUrl      String?          // Cloud storage path
  
  // Metadata
  preparedBy        String?
  preparedAt        DateTime?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@map("delivery_notes")
  @@index([projectId])
  @@index([noteNumber])
}

enum DeliveryNoteType {
  DELIVERY
  COLLECTION
}

// Approved Documents (10a/10b/10c/10d)
model ApprovedDocument {
  id            String          @id @default(cuid())
  projectId     String
  project       Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type          ApprovedDocType
  fileName      String
  cloudPath     String
  fileSize      BigInt
  mimeType      String
  
  version       Int             @default(1)
  locked        Boolean         @default(false)
  
  approvedById  String
  approvedBy    User            @relation(fields: [approvedById], references: [id])
  approvedAt    DateTime        @default(now())
  
  notes         String?         @db.Text

  @@map("approved_documents")
  @@index([projectId, type])
}

enum ApprovedDocType {
  QUOTATION      // 10a
  PURCHASE_ORDER // 10b
  DRAWING        // 10c
  AGREEMENT      // 10d
}

// Project Attachments (for general files)
model ProjectAttachment {
  id            String   @id @default(cuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  fileName      String
  originalName  String
  fileSize      BigInt
  mimeType      String
  cloudStoragePath String
  
  category      String?  // "Enquiry", "Customer Replies", "Quotes", etc.
  subCategory   String?  // For drawing workflow: "05a", "05b", etc.
  
  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id])
  uploadedAt    DateTime @default(now())

  @@map("project_attachments")
  @@index([projectId])
}

// BaseNumber Sequence (for atomic allocation)
model BaseNumberSequence {
  id            String   @id @default(cuid())
  currentNumber Int      @default(10000)
  yearPrefix    String?  // Optional: "2025", etc.
  lastReset     DateTime?
  
  updatedAt     DateTime @updatedAt

  @@map("base_number_sequence")
}

// ==========================================
// KNOWLEDGE SMELTER DATA PROCESSING SYSTEM
// ==========================================

// Archived File Storage and Classification
model ArchivedFile {
  id                    String              @id @default(cuid())
  fileName              String
  originalPath          String              // Original SharePoint path
  fileExtension         String?
  fileSize              BigInt
  mimeType              String?
  
  // Storage locations
  cloudStoragePath      String              // S3/cloud storage key
  sharePointUrl         String?             // New organized SharePoint URL
  sharePointDriveId     String?
  sharePointItemId      String?
  
  // Classification
  fileType              FileType
  confidence            Float               // AI classification confidence (0-100)
  classificationMethod  String              @default("AI") // "AI", "Manual", "Rule-based"
  
  // Extracted metadata
  jobNumber             String?
  customerName          String?
  customerCompanyNumber String?             // From Companies House lookup
  productType           String?
  extractedDate         DateTime?
  documentNumber        String?             // Invoice #, Quote #, Drawing #, etc.
  versionNumber         String?             // For versioned documents
  
  // Content analysis
  textContent           String?             @db.Text // Extracted text for search
  summary               String?             @db.Text // AI-generated summary
  language              String?             @default("en")
  pageCount             Int?
  
  // Retention and archival
  retentionYears        Int
  archiveAfter          DateTime?
  isArchived            Boolean             @default(false)
  archivedAt            DateTime?
  
  // Quality flags
  isCorrupted           Boolean             @default(false)
  isDuplicate           Boolean             @default(false)
  duplicateOfId         String?
  duplicateOf           ArchivedFile?       @relation("FileDuplicates", fields: [duplicateOfId], references: [id])
  duplicates            ArchivedFile[]      @relation("FileDuplicates")
  
  isSensitive           Boolean             @default(false)
  sensitivityLevel      SensitivityLevel?
  redactionRequired     Boolean             @default(false)
  
  // Processing status
  processingStatus      ProcessingStatus    @default(PENDING)
  processingError       String?             @db.Text
  processingAttempts    Int                 @default(0)
  lastProcessedAt       DateTime?
  
  // Relationships
  tags                  FileTag[]
  relationships         FileRelationship[]  @relation("SourceFile")
  relatedTo             FileRelationship[]  @relation("TargetFile")
  
  // Batch tracking
  batchId               String?
  batch                 ProcessingBatch?    @relation(fields: [batchId], references: [id])
  
  // Audit
  processedById         String?
  manuallyReviewedById  String?
  manuallyReviewedAt    DateTime?
  reviewNotes           String?             @db.Text
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt

  @@map("archived_files")
  @@index([fileType])
  @@index([jobNumber])
  @@index([customerName])
  @@index([processingStatus])
  @@index([confidence])
  @@index([batchId])
  @@index([createdAt])
}

// File Type Classification (12 categories from spec)
enum FileType {
  // Financial (7 year retention)
  INVOICE
  PURCHASE_ORDER
  DELIVERY_NOTE
  
  // Sales (7 year retention, versioned)
  QUOTE
  DYNAMIC_PRICING
  
  // Technical (Permanent, versioned)
  DRAWING
  TECHNICAL_SPEC
  WARRANTY
  WARRANTY_RECALL
  
  // Legal (Permanent)
  CONTRACT
  
  // Communication (7 years)
  CORRESPONDENCE
  EMAIL
  
  // Products (Permanent)
  PRODUCT_SPEC
  PRODUCT_CATALOG
  
  // Other
  PHOTO
  REPORT
  SPREADSHEET
  PRESENTATION
  OTHER
  UNCLASSIFIED
}

enum ProcessingStatus {
  PENDING
  ANALYZING
  CLASSIFIED
  NEEDS_REVIEW
  MANUALLY_REVIEWED
  UPLOADED
  COMPLETED
  FAILED
  QUARANTINED
}

enum SensitivityLevel {
  PUBLIC
  INTERNAL
  CONFIDENTIAL
  RESTRICTED
  HIGHLY_RESTRICTED
}

// Tag System for flexible metadata
model FileTag {
  id            String       @id @default(cuid())
  key           String       // "job", "customer", "product", "year", "project", etc.
  value         String
  source        String       @default("AI") // "AI", "Manual", "Extracted", "Inferred"
  confidence    Float?       // For AI-generated tags
  
  fileId        String
  file          ArchivedFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime     @default(now())

  @@map("file_tags")
  @@index([fileId])
  @@index([key, value])
}

// File Relationships (versions, references, threads)
model FileRelationship {
  id              String          @id @default(cuid())
  
  sourceFileId    String
  sourceFile      ArchivedFile    @relation("SourceFile", fields: [sourceFileId], references: [id], onDelete: Cascade)
  
  targetFileId    String
  targetFile      ArchivedFile    @relation("TargetFile", fields: [targetFileId], references: [id], onDelete: Cascade)
  
  relationshipType RelationshipType
  strength        Int             @default(5) // 1-10 scale
  description     String?
  
  createdAt       DateTime        @default(now())

  @@map("file_relationships")
  @@unique([sourceFileId, targetFileId, relationshipType])
  @@index([sourceFileId])
  @@index([targetFileId])
}

enum RelationshipType {
  VERSION_OF          // Drawing v2 is version of Drawing v1
  SUPERSEDES          // New quote supersedes old quote
  REFERENCES          // Email references invoice
  PART_OF_THREAD      // Email thread relationship
  ATTACHED_TO         // File attached to email
  RELATED_TO_JOB      // Files belong to same job
  SUPPORTS            // Supporting document
  GENERATED_FROM      // Invoice generated from quote
}

// Batch Processing Tracking
model ProcessingBatch {
  id                String       @id @default(cuid())
  batchName         String       @unique
  description       String?
  
  // Source information
  sourceLocation    String       // SharePoint path, folder name
  totalSizeGB       Decimal      @db.Decimal(10,2)
  estimatedFiles    Int?
  
  // Processing stats
  filesQueued       Int          @default(0)
  filesProcessed    Int          @default(0)
  filesSucceeded    Int          @default(0)
  filesFailed       Int          @default(0)
  filesSkipped      Int          @default(0)
  
  // Classification breakdown
  highConfidence    Int          @default(0) // ≥85%
  mediumConfidence  Int          @default(0) // 50-84%
  lowConfidence     Int          @default(0) // <50%
  
  // Time tracking
  startedAt         DateTime?
  completedAt       DateTime?
  estimatedDuration Int?         // minutes
  actualDuration    Int?         // minutes
  
  // Status
  status            BatchStatus  @default(PENDING)
  progress          Float        @default(0) // 0-100%
  
  // Error tracking
  errorLog          Json?        // Array of errors
  warningCount      Int          @default(0)
  
  // Results
  reportUrl         String?      // Link to processing report
  statsJson         Json?        // Detailed statistics
  
  // Related files
  files             ArchivedFile[]
  
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("processing_batches")
  @@index([status])
  @@index([batchName])
}

enum BatchStatus {
  PENDING
  QUEUED
  PROCESSING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

// Processing Activity Log
model ProcessingLog {
  id              String       @id @default(cuid())
  
  level           LogLevel
  category        String       // "classification", "extraction", "upload", "error"
  message         String       @db.Text
  
  // Context
  fileId          String?
  fileName        String?
  batchId         String?
  batchName       String?
  
  // Technical details
  errorCode       String?
  errorStack      String?      @db.Text
  metadata        Json?        // Additional context
  
  // Performance
  duration        Int?         // milliseconds
  memoryUsed      Int?         // MB
  
  createdAt       DateTime     @default(now())

  @@map("processing_logs")
  @@index([level])
  @@index([category])
  @@index([fileId])
  @@index([batchId])
  @@index([createdAt])
}

enum LogLevel {
  DEBUG
  INFO
  WARNING
  ERROR
  CRITICAL
}

// Classification Rules and Configuration
model ClassificationRule {
  id              String       @id @default(cuid())
  name            String       @unique
  description     String?
  
  fileType        FileType
  priority        Int          @default(0) // Higher = checked first
  
  // Matching criteria
  fileNamePatterns String[]    @default([]) // Regex patterns
  contentPatterns  String[]    @default([]) // Text patterns in content
  extensionMatch   String[]    @default([]) // File extensions
  sizeMin          BigInt?
  sizeMax          BigInt?
  
  // Actions
  autoTag          Json?       // Automatic tags to apply
  retentionYears   Int
  requiresReview   Boolean     @default(false)
  
  isActive         Boolean     @default(true)
  
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@map("classification_rules")
  @@index([fileType])
  @@index([priority])
}
